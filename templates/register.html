<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>New Registration - Craft Chain</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;700&family=Inter:wght@300;400;500&display=swap" rel="stylesheet" />
  <style>
    /* Reset */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: linear-gradient(180deg, #fdfdfb 0%, #faf7f5 60%, #f6f1ee 100%); color: #2a2a2a; min-height: 100vh; display: flex; justify-content: center; align-items: flex-start; padding: 2rem 1rem; }

    /* Shell */
    .container { background: #fff; border-radius: 18px; box-shadow: 0 16px 40px rgba(0,0,0,0.08); max-width: 640px; width: 100%; padding: 2rem 2rem 2.2rem; border: 1px solid #f0ece8; }
    h2 { font-family: 'Playfair Display', serif; font-weight: 700; font-size: 2.1rem; margin-bottom: 1.3rem; color: #5b3c33; text-align: center; letter-spacing: .3px; }

    /* Tabs */
    .tabs { display: flex; justify-content: center; gap: .8rem; margin-bottom: 1.6rem; }
    .tab { padding: 0.6rem 1.2rem; cursor: pointer; font-weight: 700; font-size: 1rem; color: #6b564e; border: 1px solid #eadfd9; border-radius: 999px; user-select: none; background: #faf7f5; transition: transform .15s ease, box-shadow .2s ease, color .2s ease, background .2s ease; }
    .tab:hover { transform: translateY(-1px); box-shadow: 0 8px 16px rgba(0,0,0,.06); }
    .tab.active { background: #5b3c33; border-color: #5b3c33; color: #fff; }

    /* Forms */
    form { display: none; flex-direction: column; gap: 1rem; }
    form.active { display: flex; animation: fadeIn .25s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(4px);} to { opacity: 1; transform: translateY(0);} }

    label { font-weight: 600; color: #5b3c33; margin-bottom: 0.25rem; display: block; }
    input[type="text"], input[type="email"], input[type="tel"], input[type="password"], textarea, input[type="file"] { width: 100%; padding: 0.7rem 0.9rem; border: 1px solid #e2d9d4; border-radius: 10px; font-size: 1rem; font-family: 'Inter', sans-serif; background: #fff; transition: border-color .2s ease, box-shadow .2s ease; }
    input[type="text"]:focus, input[type="email"]:focus, input[type="tel"]:focus, input[type="password"]:focus, textarea:focus { border-color: #c6a89a; outline: none; box-shadow: 0 0 0 4px rgba(91,60,51,.12); }
    textarea { min-height: 72px; resize: vertical; }

    button { background-color: #5b3c33; color: white; padding: 0.85rem 1.2rem; border: none; border-radius: 10px; font-size: 1.05rem; font-weight: 700; cursor: pointer; transition: transform .15s ease, box-shadow .2s ease, background .2s ease; margin-top: 0.25rem; align-self: start; }
    button:hover { background-color: #3e2a22; transform: translateY(-1px); box-shadow: 0 10px 18px rgba(62,42,34,.18); }

    /* Responsive */
    @media (max-width: 480px) { .container { padding: 1.5rem 1.25rem; } .tab { padding: 0.5rem 0.9rem; font-size: .95rem; } }
  </style>
</head>
<body>
  <script src="/static/config.js"></script>
  <div class="container">
    <h2>New Registration</h2>
    <div class="tabs">
      <div class="tab active" data-target="buyer-form">Buyer</div>
      <div class="tab" data-target="seller-form">Seller</div>
    </div>

    <!-- Buyer Registration Form -->
    <form id="buyer-form" class="active" action="#" method="POST" enctype="multipart/form-data" novalidate>
      <label for="buyer-fullname">Full Name</label>
      <input type="text" id="buyer-fullname" name="fullname" placeholder="Your full name" required />

      <label for="buyer-email">Email</label>
      <input type="email" id="buyer-email" name="email" placeholder="abc@gmail.com" required />

      <label for="buyer-phone">Phone Number</label>
      <input type="tel" id="buyer-phone" name="phone" placeholder="+91" pattern="[0-9+ ]{7,15}" required />

      <label for="buyer-address">Address</label>
      <textarea id="buyer-address" name="address" placeholder="Your address" required></textarea>

      <label for="buyer-password">Password</label>
      <input type="password" id="buyer-password" name="password" placeholder="Enter password" required minlength="6" />

      <label for="buyer-confirm-password">Confirm Password</label>
      <input type="password" id="buyer-confirm-password" name="confirm_password" placeholder="Confirm password" required minlength="6" />

      <button type="submit">Register as Buyer</button>
    </form>

    <!-- Seller Registration Form -->
    <form id="seller-form" action="#" method="POST" enctype="multipart/form-data" novalidate>
      <label for="seller-fullname">Full Name</label>
      <input type="text" id="seller-fullname" name="fullname" placeholder="Your full name" required />

      <label for="seller-email">Email</label>
      <input type="email" id="seller-email" name="email" placeholder="abc@gmail.com" required />

      <label for="seller-phone">Phone Number</label>
      <input type="tel" id="seller-phone" name="phone" placeholder="+91" pattern="[0-9+ ]{7,15}" required />

      <label for="seller-address">Address + Location</label>
      <textarea id="seller-address" name="address_location" placeholder="Your address and location" required></textarea>

      <label for="govt-id">Government ID / Artisan ID Upload</label>
      <input type="file" id="govt-id" name="govt_id" accept=".jpg,.jpeg,.png,.pdf" required />


      <label for="payment-details">Bank / Wallet Details for Payment</label>
      <textarea id="payment-details" name="payment_details" placeholder="Bank account or wallet details" required></textarea>

      <label for="seller-password">Password</label>
      <input type="password" id="seller-password" name="password" placeholder="Enter password" required minlength="6" />

      <label for="seller-confirm-password">Confirm Password</label>
      <input type="password" id="seller-confirm-password" name="confirm_password" placeholder="Confirm password" required minlength="6" />

      <button type="submit">Register as Seller</button>
    </form>
  </div>

  <script>
    // Tab switching logic
    const tabs = document.querySelectorAll('.tab');
    const forms = document.querySelectorAll('form');

    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        // Remove active class from all tabs and forms
        tabs.forEach(t => t.classList.remove('active'));
        forms.forEach(f => f.classList.remove('active'));

        // Add active class to clicked tab and corresponding form
        tab.classList.add('active');
        const target = tab.getAttribute('data-target');
        document.getElementById(target).classList.add('active');
      });
    });

    // Optional: Password confirmation validation
    function validatePasswordMatch(form) {
      const password = form.querySelector('input[name="password"]');
      const confirmPassword = form.querySelector('input[name="confirm_password"]');
      if (password.value !== confirmPassword.value) {
        confirmPassword.setCustomValidity("Passwords do not match");
      } else {
        confirmPassword.setCustomValidity("");
      }
    }

    document.getElementById('buyer-form').addEventListener('input', function() {
      validatePasswordMatch(this);
    });

    document.getElementById('seller-form').addEventListener('input', function() {
      validatePasswordMatch(this);
    });

    // Handle form submissions
    // Small helper to safely parse JSON or fallback to text
    async function safeParse(res) {
      const ct = res.headers.get('content-type') || '';
      if (ct.includes('application/json')) {
        return await res.json();
      }
      // fallback: plain text (e.g., HTML error page in debug mode)
      const text = await res.text();
      return { error: text.slice(0, 500) };
    }

    document.getElementById('buyer-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const formData = new FormData(this);
      const password = formData.get('password');
      const confirmPassword = formData.get('confirm_password');
      
      // Validate password match
      if (password !== confirmPassword) {
        alert('Passwords do not match');
        return;
      }
      
      try {
        const res = await fetch('/api/register/buyer', {
          method: 'POST',
          body: formData
        });
        const data = await safeParse(res);
        if (!res.ok) throw new Error(data.error || 'Registration failed');

        // Store user info in localStorage
        localStorage.setItem('userRole', 'buyer');
        localStorage.setItem('userEmail', formData.get('email'));
        localStorage.setItem('userName', formData.get('fullname'));
        localStorage.setItem('isLoggedIn', 'true');
        
        alert('Registration successful! Welcome to Craft Chain.');
        // Redirect buyers to login page
        window.location.href = '/login';
      } catch (err) {
        alert(err.message);
      }
    });

    document.getElementById('seller-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const formData = new FormData(this);
      const password = formData.get('password');
      const confirmPassword = formData.get('confirm_password');
      
      // Validate password match
      if (password !== confirmPassword) {
        alert('Passwords do not match');
        return;
      }
      
      // Check if government ID file is uploaded
      const govtId = formData.get('govt_id');
      if (!govtId || govtId.size === 0) {
        alert('Please upload your Government ID / Artisan ID');
        return;
      }
      
      try {
        const res = await fetch('/api/register/seller', {
          method: 'POST',
          body: formData
        });
        const data = await safeParse(res);
        if (!res.ok) throw new Error(data.error || 'Registration failed');

        // Store user info in localStorage
        localStorage.setItem('userRole', 'seller');
        localStorage.setItem('userEmail', formData.get('email'));
        localStorage.setItem('userName', formData.get('fullname'));
        localStorage.setItem('userPhone', formData.get('phone'));
        localStorage.setItem('userAddress', formData.get('address_location'));
        localStorage.setItem('isLoggedIn', 'true');
        
        alert('Seller registration successful! Welcome to Craft Chain. You can now add your products.');
        // Redirect sellers to login page
        window.location.href = '/login';
      } catch (err) {
        alert(err.message);
      }
    });
  </script>
</body>
</html>